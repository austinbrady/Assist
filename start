#!/bin/bash

# AssisantAI - Unified Startup Script
# Starts all services (middleware, hub, backends, frontends) with correct ports

set +e  # Don't exit on error - we'll handle errors manually

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Get project root
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Create logs directory
mkdir -p logs

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}üöÄ Starting AssisantAI${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Run update script if it exists
if [ -f "update.sh" ]; then
    echo -e "${BLUE}üîÑ Running auto-update check...${NC}"
    bash update.sh || {
        echo -e "${YELLOW}‚ö†Ô∏è  Update check failed, continuing anyway...${NC}"
    }
    echo ""
fi

# Read ports from config/ports.json
PORTS_FILE="config/ports.json"
if [ ! -f "$PORTS_FILE" ]; then
    echo -e "${RED}‚ùå Error: $PORTS_FILE not found${NC}"
    exit 1
fi

# Function to get port from ports.json
get_port() {
    local app_id=$1
    if command -v python3 &> /dev/null; then
        python3 - "$SCRIPT_DIR" "$PORTS_FILE" "$app_id" <<'PYTHON_EOF'
import json
import sys
import os
script_dir = sys.argv[1]
ports_file = sys.argv[2]
app_id = sys.argv[3]
config_path = os.path.join(script_dir, ports_file)
if os.path.exists(config_path):
    with open(config_path, 'r') as f:
        config = json.load(f)
    app = next((a for a in config['apps'] if a['id'] == app_id), None)
    print(app['port'] if app else '')
else:
    print('')
PYTHON_EOF
    elif command -v node &> /dev/null; then
        node -e "const fs = require('fs'); const path = require('path'); const scriptDir = process.argv[1]; const portsFile = process.argv[2]; const appId = process.argv[3]; const configPath = path.join(scriptDir, portsFile); try { const config = JSON.parse(fs.readFileSync(configPath, 'utf8')); const app = config.apps.find(a => a.id === appId); console.log(app ? app.port : ''); } catch(e) { console.log(''); }" "$SCRIPT_DIR" "$PORTS_FILE" "$app_id"
    else
        echo ""
    fi
}

# Get all ports
MIDDLEWARE_PORT=$(get_port "middleware")
HUB_PORT=$(get_port "hub")
MVP_BACKEND_PORT=$(get_port "mvpassistant-backend")
PERSONALAI_BACKEND_PORT=$(get_port "personalai-backend")
PERSONALAI_FRONTEND_PORT=$(get_port "personalai-frontend")
MVP_FRONTEND_PORT=$(get_port "mvpassistant-frontend")
PROMPTWRITER_BACKEND_PORT=$(get_port "promptwriter-backend")
PROMPTWRITER_FRONTEND_PORT=$(get_port "promptwriter-frontend")

# Validate ports
if [ -z "$MIDDLEWARE_PORT" ] || [ -z "$HUB_PORT" ] || [ -z "$MVP_BACKEND_PORT" ] || [ -z "$PERSONALAI_BACKEND_PORT" ] || [ -z "$PERSONALAI_FRONTEND_PORT" ] || [ -z "$MVP_FRONTEND_PORT" ] || [ -z "$PROMPTWRITER_BACKEND_PORT" ] || [ -z "$PROMPTWRITER_FRONTEND_PORT" ]; then
    echo -e "${RED}‚ùå Error: Could not read ports from $PORTS_FILE${NC}"
    exit 1
fi

# Function to check if port is in use
check_port() {
    local port=$1
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0  # Port is in use
    else
        return 1  # Port is free
    fi
}

# Function to start service
start_service() {
    local name=$1
    local port=$2
    local start_cmd=$3
    local log_file=$4
    local pid_file=$5
    
    if check_port $port; then
        echo -e "${YELLOW}  ‚ö†Ô∏è  $name is already running on port $port${NC}"
        return 0
    fi
    
    echo -e "${GREEN}  Starting $name on port $port...${NC}"
    local abs_log_file="$SCRIPT_DIR/$log_file"
    local abs_pid_file="$SCRIPT_DIR/$pid_file"
    eval "$start_cmd" > "$abs_log_file" 2>&1 &
    local pid=$!
    echo $pid > "$abs_pid_file"
    echo -e "${GREEN}  ‚úÖ $name started (PID: $pid)${NC}"
    sleep 2
}

# 1. Start Middleware (MUST be first - other services depend on it)
echo -e "${BLUE}[1/8] Middleware${NC}"
if [ ! -d "$SCRIPT_DIR/middleware/node_modules" ]; then
    echo -e "${YELLOW}  Installing dependencies...${NC}"
    if (cd "$SCRIPT_DIR/middleware" && npm install --silent); then
        echo -e "${GREEN}  ‚úÖ Dependencies installed${NC}"
    else
        echo -e "${RED}  ‚ùå Failed to install dependencies${NC}"
        exit 1
    fi
fi
# Verify tsx is available for dev mode (tsx runs TypeScript directly, no build needed)
if ! (cd "$SCRIPT_DIR/middleware" && npm list tsx > /dev/null 2>&1); then
    echo -e "${YELLOW}  Installing tsx for TypeScript execution...${NC}"
    (cd "$SCRIPT_DIR/middleware" && npm install tsx --save-dev --silent)
fi
start_service "Middleware" $MIDDLEWARE_PORT \
    "cd \"$SCRIPT_DIR/middleware\" && export PORT=$MIDDLEWARE_PORT && npm run dev" \
    "logs/middleware.log" \
    "logs/middleware.pid"

# 2. Start Central Hub
echo -e "${BLUE}[2/8] Central Hub${NC}"
if [ ! -d "$SCRIPT_DIR/hub/node_modules" ]; then
    echo -e "${YELLOW}  Installing dependencies...${NC}"
    if (cd "$SCRIPT_DIR/hub" && npm install --silent); then
        echo -e "${GREEN}  ‚úÖ Dependencies installed${NC}"
    else
        echo -e "${RED}  ‚ùå Failed to install dependencies${NC}"
        exit 1
    fi
fi
start_service "Central Hub" $HUB_PORT \
    "cd \"$SCRIPT_DIR/hub\" && npm run dev" \
    "logs/hub.log" \
    "logs/hub.pid"

# 3. Start MVP Assistant Backend
echo -e "${BLUE}[3/8] MVP Assistant Backend${NC}"
if [ ! -d "$SCRIPT_DIR/apps/mvpassistant/backend/venv" ]; then
    echo -e "${RED}  ‚ùå Dependencies not installed. Run: cd apps/mvpassistant && ./INSTALL.sh${NC}"
else
    start_service "MVP Assistant Backend" $MVP_BACKEND_PORT \
        "cd \"$SCRIPT_DIR/apps/mvpassistant/backend\" && source venv/bin/activate && export PORT=$MVP_BACKEND_PORT && uvicorn main:app --host 0.0.0.0 --port $MVP_BACKEND_PORT" \
        "logs/mvpassistant-backend.log" \
        "logs/mvpassistant-backend.pid"
fi

# 4. Start PersonalAI Backend
echo -e "${BLUE}[4/8] PersonalAI Backend${NC}"
if [ ! -d "$SCRIPT_DIR/apps/personalai/backend/venv" ]; then
    echo -e "${RED}  ‚ùå Dependencies not installed. Run: ./install.sh${NC}"
else
    echo -e "${YELLOW}  Verifying dependencies...${NC}"
    if (cd "$SCRIPT_DIR/apps/personalai/backend" && source venv/bin/activate && python -c "import fastapi, uvicorn, httpx, pydantic, dotenv" 2>/dev/null); then
        echo -e "${GREEN}  ‚úÖ Core dependencies verified${NC}"
    else
        echo -e "${YELLOW}  ‚ö†Ô∏è  Some dependencies may be missing. Attempting to install...${NC}"
        (cd "$SCRIPT_DIR/apps/personalai/backend" && source venv/bin/activate && pip install --upgrade pip setuptools wheel --quiet && pip install -r requirements.txt --quiet 2>&1 | tail -5)
    fi
    
    start_service "PersonalAI Backend" $PERSONALAI_BACKEND_PORT \
        "cd \"$SCRIPT_DIR/apps/personalai/backend\" && source venv/bin/activate && export PORT=$PERSONALAI_BACKEND_PORT && export MIDDLEWARE_PORT=$MIDDLEWARE_PORT && uvicorn main:app --host 0.0.0.0 --port $PERSONALAI_BACKEND_PORT" \
        "logs/personalai-backend.log" \
        "logs/personalai-backend.pid"
fi

# 5. Start PersonalAI Frontend
echo -e "${BLUE}[5/8] PersonalAI Frontend${NC}"
if [ ! -d "$SCRIPT_DIR/apps/personalai/frontend/node_modules" ]; then
    echo -e "${YELLOW}  Installing dependencies...${NC}"
    if (cd "$SCRIPT_DIR/apps/personalai/frontend" && npm install --silent); then
        echo -e "${GREEN}  ‚úÖ Dependencies installed${NC}"
    else
        echo -e "${RED}  ‚ùå Failed to install dependencies${NC}"
        exit 1
    fi
fi
start_service "PersonalAI Frontend" $PERSONALAI_FRONTEND_PORT \
    "cd \"$SCRIPT_DIR/apps/personalai/frontend\" && export PORT=$PERSONALAI_FRONTEND_PORT && npm run dev -- -p $PERSONALAI_FRONTEND_PORT -H 0.0.0.0" \
    "logs/personalai-frontend.log" \
    "logs/personalai-frontend.pid"

# 6. Start MVP Assistant Frontend
echo -e "${BLUE}[6/8] MVP Assistant Frontend${NC}"
if [ ! -d "$SCRIPT_DIR/apps/mvpassistant/frontend/node_modules" ]; then
    echo -e "${YELLOW}  Installing dependencies...${NC}"
    if (cd "$SCRIPT_DIR/apps/mvpassistant/frontend" && npm install --silent); then
        echo -e "${GREEN}  ‚úÖ Dependencies installed${NC}"
    else
        echo -e "${RED}  ‚ùå Failed to install dependencies${NC}"
        exit 1
    fi
fi
start_service "MVP Assistant Frontend" $MVP_FRONTEND_PORT \
    "cd \"$SCRIPT_DIR/apps/mvpassistant/frontend\" && export PORT=$MVP_FRONTEND_PORT && npm run dev -- -p $MVP_FRONTEND_PORT -H 0.0.0.0" \
    "logs/mvpassistant-frontend.log" \
    "logs/mvpassistant-frontend.pid"

# 7. Start Prompt Writer Backend
echo -e "${BLUE}[7/8] Prompt Writer Backend${NC}"
if [ ! -d "$SCRIPT_DIR/apps/promptwriter/backend/venv" ]; then
    echo -e "${YELLOW}  Installing dependencies...${NC}"
    if (cd "$SCRIPT_DIR/apps/promptwriter/backend" && python3 -m venv venv && source venv/bin/activate && pip install --upgrade pip setuptools wheel --quiet && pip install -q -r requirements.txt); then
        echo -e "${GREEN}  ‚úÖ Dependencies installed${NC}"
    else
        echo -e "${RED}  ‚ùå Failed to install dependencies${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}  Verifying dependencies...${NC}"
    if (cd "$SCRIPT_DIR/apps/promptwriter/backend" && source venv/bin/activate && python -c "import fastapi, uvicorn, httpx, pydantic, dotenv" 2>/dev/null); then
        echo -e "${GREEN}  ‚úÖ Core dependencies verified${NC}"
    else
        echo -e "${YELLOW}  ‚ö†Ô∏è  Some dependencies may be missing. Attempting to install...${NC}"
        (cd "$SCRIPT_DIR/apps/promptwriter/backend" && source venv/bin/activate && pip install --upgrade pip setuptools wheel --quiet && pip install -r requirements.txt --quiet 2>&1 | tail -5)
    fi
fi
start_service "Prompt Writer Backend" $PROMPTWRITER_BACKEND_PORT \
    "cd \"$SCRIPT_DIR/apps/promptwriter/backend\" && source venv/bin/activate && export PROMPTWRITER_BACKEND_PORT=$PROMPTWRITER_BACKEND_PORT && uvicorn main:app --host 0.0.0.0 --port $PROMPTWRITER_BACKEND_PORT" \
    "logs/promptwriter-backend.log" \
    "logs/promptwriter-backend.pid"

# 8. Start Prompt Writer Frontend
echo -e "${BLUE}[8/8] Prompt Writer Frontend${NC}"
if [ ! -d "$SCRIPT_DIR/apps/promptwriter/frontend/node_modules" ]; then
    echo -e "${YELLOW}  Installing dependencies...${NC}"
    if (cd "$SCRIPT_DIR/apps/promptwriter/frontend" && npm install --silent); then
        echo -e "${GREEN}  ‚úÖ Dependencies installed${NC}"
    else
        echo -e "${RED}  ‚ùå Failed to install dependencies${NC}"
        exit 1
    fi
fi
start_service "Prompt Writer Frontend" $PROMPTWRITER_FRONTEND_PORT \
    "cd \"$SCRIPT_DIR/apps/promptwriter/frontend\" && export PORT=$PROMPTWRITER_FRONTEND_PORT && npm run dev -- -p $PROMPTWRITER_FRONTEND_PORT -H 0.0.0.0" \
    "logs/promptwriter-frontend.log" \
    "logs/promptwriter-frontend.pid"

# Get network IP address
NETWORK_IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -1)
if [ -z "$NETWORK_IP" ]; then
    NETWORK_IP="<your-network-ip>"
fi

echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}‚úÖ All Services Started!${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "${GREEN}Access Points (Local):${NC}"
echo "  üéõÔ∏è  Central Hub:        http://localhost:$HUB_PORT"
echo "  üîå Middleware API:      http://localhost:$MIDDLEWARE_PORT"
echo "  ü§ñ PersonalAI Backend:   http://localhost:$PERSONALAI_BACKEND_PORT"
echo "  üé® PersonalAI Frontend: http://localhost:$PERSONALAI_FRONTEND_PORT"
echo "  üöÄ MVP Assistant Backend:  http://localhost:$MVP_BACKEND_PORT"
echo "  üíº MVP Assistant Frontend: http://localhost:$MVP_FRONTEND_PORT"
echo "  ‚úçÔ∏è  Prompt Writer Backend:  http://localhost:$PROMPTWRITER_BACKEND_PORT"
echo "  üìù Prompt Writer Frontend: http://localhost:$PROMPTWRITER_FRONTEND_PORT"
echo ""
echo -e "${GREEN}Access Points (Network):${NC}"
echo "  üéõÔ∏è  Central Hub:        http://$NETWORK_IP:$HUB_PORT"
echo "  üîå Middleware API:      http://$NETWORK_IP:$MIDDLEWARE_PORT"
echo "  ü§ñ PersonalAI Backend:   http://$NETWORK_IP:$PERSONALAI_BACKEND_PORT"
echo "  üé® PersonalAI Frontend: http://$NETWORK_IP:$PERSONALAI_FRONTEND_PORT"
echo "  üöÄ MVP Assistant Backend:  http://$NETWORK_IP:$MVP_BACKEND_PORT"
echo "  üíº MVP Assistant Frontend: http://$NETWORK_IP:$MVP_FRONTEND_PORT"
echo "  ‚úçÔ∏è  Prompt Writer Backend:  http://$NETWORK_IP:$PROMPTWRITER_BACKEND_PORT"
echo "  üìù Prompt Writer Frontend: http://$NETWORK_IP:$PROMPTWRITER_FRONTEND_PORT"
echo ""
echo -e "${GREEN}Logs:${NC}"
echo "  - Middleware:              logs/middleware.log"
echo "  - Hub:                     logs/hub.log"
echo "  - PersonalAI Backend:      logs/personalai-backend.log"
echo "  - PersonalAI Frontend:     logs/personalai-frontend.log"
echo "  - MVP Assistant Backend:   logs/mvpassistant-backend.log"
echo "  - MVP Assistant Frontend:  logs/mvpassistant-frontend.log"
echo "  - Prompt Writer Backend:   logs/promptwriter-backend.log"
echo "  - Prompt Writer Frontend:  logs/promptwriter-frontend.log"
echo ""
echo -e "${YELLOW}To stop all services, run:${NC}"
echo "  ./stop"
echo ""

# Try to open browser after a short delay
set +e
echo -e "${BLUE}Opening Central Hub in your browser...${NC}"
sleep 2

curl -s --max-time 0.5 --connect-timeout 0.5 "http://localhost:$HUB_PORT" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Hub is ready!${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Hub may still be starting. Opening anyway...${NC}"
    echo -e "${YELLOW}   If the page doesn't load, wait a few seconds and refresh.${NC}"
    echo -e "${YELLOW}   Check logs/hub.log if there are issues.${NC}"
fi

echo ""
echo -e "${BLUE}[9/9] LLM Connection Verification${NC}"
echo -e "${YELLOW}  Opening verification page...${NC}"
sleep 3
open "http://localhost:$HUB_PORT/verify" 2>/dev/null || xdg-open "http://localhost:$HUB_PORT/verify" 2>/dev/null || echo "Please manually open http://localhost:$HUB_PORT/verify in your browser"
echo -e "${GREEN}  ‚úÖ Verification page opened${NC}"
echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}Setup Complete!${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "Next steps:"
echo "  1. Verify Ollama connection (required)"
echo "  2. Verify Gemini API configuration (optional)"
echo "  3. Click 'Continue to Hub' when ready"
echo ""

set -e
echo ""

